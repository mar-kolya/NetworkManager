From: Nikolay Martynov <mar.kolya@gmail.com>
Date: Sun, 21 May 2017 17:07:17 -0400
Subject: Bond: add support for cloned mac

---
 clients/tui/nmt-page-bond.c | 18 ++++++++++++++++++
 clients/tui/nmt-page-vlan.c |  5 +++--
 2 files changed, 21 insertions(+), 2 deletions(-)

diff --git a/clients/tui/nmt-page-bond.c b/clients/tui/nmt-page-bond.c
index 48070db..b17bb05 100644
--- a/clients/tui/nmt-page-bond.c
+++ b/clients/tui/nmt-page-bond.c
@@ -29,6 +29,7 @@
 
 #include "nmt-page-bond.h"
 
+#include "nmt-mac-entry.h"
 #include "nmt-address-list.h"
 #include "nmt-slave-list.h"
 
@@ -43,6 +44,8 @@ typedef enum {
 } NmtPageBondMonitoringMode;
 
 typedef struct {
+	NMSettingWired *s_wired;
+
 	NmtSlaveList *slaves;
 
 	NmtNewtPopup *mode;
@@ -336,6 +339,7 @@ nmt_page_bond_constructed (GObject *object)
 	NmtPageBondPrivate *priv = NMT_PAGE_BOND_GET_PRIVATE (bond);
 	NmtEditorSection *section;
 	NmtEditorGrid *grid;
+	NMSettingWired *s_wired;
 	NMSettingBond *s_bond;
 	NmtNewtWidget *widget, *label;
 	NMConnection *conn;
@@ -348,6 +352,13 @@ nmt_page_bond_constructed (GObject *object)
 	}
 	priv->s_bond = s_bond;
 
+	s_wired = nm_connection_get_setting_wired (conn);
+	if (!s_wired) {
+		nm_connection_add_setting (conn, nm_setting_wired_new ());
+		s_wired = nm_connection_get_setting_wired (conn);
+	}
+	priv->s_wired = s_wired;
+
 	section = nmt_editor_section_new (_("BOND"), NULL, TRUE);
 	grid = nmt_editor_section_get_body (section);
 
@@ -361,6 +372,12 @@ nmt_page_bond_constructed (GObject *object)
 	nmt_editor_grid_append (grid, NULL, widget, NULL);
 	priv->slaves = NMT_SLAVE_LIST (widget);
 
+	widget = nmt_mac_entry_new (40, ETH_ALEN, NMT_MAC_ENTRY_TYPE_CLONED);
+	g_object_bind_property (s_wired, NM_SETTING_WIRED_CLONED_MAC_ADDRESS,
+	                        widget, "mac-address",
+	                        G_BINDING_BIDIRECTIONAL | G_BINDING_SYNC_CREATE);
+	nmt_editor_grid_append (grid, _("Cloned MAC address"), widget, NULL);
+
 	widget = nmt_newt_popup_new (bond_mode);
 	g_signal_connect (widget, "notify::active-id",
 	                  G_CALLBACK (mode_widget_changed), bond);
@@ -440,5 +457,6 @@ nmt_page_bond_class_init (NmtPageBondClass *bond_class)
 	g_type_class_add_private (bond_class, sizeof (NmtPageBondPrivate));
 
 	object_class->constructed = nmt_page_bond_constructed;
+
 	editor_page_class->saved = nmt_page_bond_saved;
 }
diff --git a/clients/tui/nmt-page-vlan.c b/clients/tui/nmt-page-vlan.c
index 9cd6542..8ad8a47 100644
--- a/clients/tui/nmt-page-vlan.c
+++ b/clients/tui/nmt-page-vlan.c
@@ -87,9 +87,10 @@ nmt_page_vlan_constructed (GObject *object)
 		 * we'll hold a ref on one, and add it to and remove it from
 		 * the connection as needed.
 		 */
-		s_wired = NM_SETTING_WIRED (nm_setting_wired_new ());
+		nm_connection_add_setting (conn, nm_setting_wired_new ());
+		s_wired = nm_connection_get_setting_wired (conn);
 	}
-	priv->s_wired = g_object_ref_sink (s_wired);
+	//priv->s_wired = g_object_ref_sink (s_wired);
 
 	section = nmt_editor_section_new (_("VLAN"), NULL, TRUE);
 	grid = nmt_editor_section_get_body (section);

From: Nikolay Martynov <mar.kolya@gmail.com>
Date: Sun, 21 May 2017 17:07:17 -0400
Subject: Bond: add support for cloned mac

---
 clients/tui/nmt-page-bond.c | 32 ++++++++++++++++++++++++++++++++
 libnm-core/nm-connection.c  |  2 +-
 2 files changed, 33 insertions(+), 1 deletion(-)

diff --git a/clients/tui/nmt-page-bond.c b/clients/tui/nmt-page-bond.c
index 48070db..30b3770 100644
--- a/clients/tui/nmt-page-bond.c
+++ b/clients/tui/nmt-page-bond.c
@@ -29,6 +29,7 @@
 
 #include "nmt-page-bond.h"
 
+#include "nmt-mac-entry.h"
 #include "nmt-address-list.h"
 #include "nmt-slave-list.h"
 
@@ -43,6 +44,8 @@ typedef enum {
 } NmtPageBondMonitoringMode;
 
 typedef struct {
+	NMSettingWired *s_wired;
+
 	NmtSlaveList *slaves;
 
 	NmtNewtPopup *mode;
@@ -336,6 +339,7 @@ nmt_page_bond_constructed (GObject *object)
 	NmtPageBondPrivate *priv = NMT_PAGE_BOND_GET_PRIVATE (bond);
 	NmtEditorSection *section;
 	NmtEditorGrid *grid;
+	NMSettingWired *s_wired;
 	NMSettingBond *s_bond;
 	NmtNewtWidget *widget, *label;
 	NMConnection *conn;
@@ -348,6 +352,16 @@ nmt_page_bond_constructed (GObject *object)
 	}
 	priv->s_bond = s_bond;
 
+	s_wired = nm_connection_get_setting_wired (conn);
+	if (!s_wired) {
+		/* It makes things simpler if we always have a NMSettingWired;
+		 * we'll hold a ref on one, and add it to and remove it from
+		 * the connection as needed.
+		 */
+		s_wired = NM_SETTING_WIRED (nm_setting_wired_new ());
+	}
+	priv->s_wired = g_object_ref_sink (s_wired);
+
 	section = nmt_editor_section_new (_("BOND"), NULL, TRUE);
 	grid = nmt_editor_section_get_body (section);
 
@@ -361,6 +375,12 @@ nmt_page_bond_constructed (GObject *object)
 	nmt_editor_grid_append (grid, NULL, widget, NULL);
 	priv->slaves = NMT_SLAVE_LIST (widget);
 
+	widget = nmt_mac_entry_new (40, ETH_ALEN, NMT_MAC_ENTRY_TYPE_CLONED);
+	g_object_bind_property (s_wired, NM_SETTING_WIRED_CLONED_MAC_ADDRESS,
+	                        widget, "mac-address",
+	                        G_BINDING_BIDIRECTIONAL | G_BINDING_SYNC_CREATE);
+	nmt_editor_grid_append (grid, _("Cloned MAC address"), widget, NULL);
+
 	widget = nmt_newt_popup_new (bond_mode);
 	g_signal_connect (widget, "notify::active-id",
 	                  G_CALLBACK (mode_widget_changed), bond);
@@ -432,6 +452,16 @@ nmt_page_bond_saved (NmtEditorPage *editor_page)
 }
 
 static void
+nmt_page_bond_finalize (GObject *object)
+{
+	NmtPageBondPrivate *priv = NMT_PAGE_BOND_GET_PRIVATE (object);
+
+	g_clear_object (&priv->s_wired);
+
+	G_OBJECT_CLASS (nmt_page_bond_parent_class)->finalize (object);
+}
+
+static void
 nmt_page_bond_class_init (NmtPageBondClass *bond_class)
 {
 	GObjectClass *object_class = G_OBJECT_CLASS (bond_class);
@@ -440,5 +470,7 @@ nmt_page_bond_class_init (NmtPageBondClass *bond_class)
 	g_type_class_add_private (bond_class, sizeof (NmtPageBondPrivate));
 
 	object_class->constructed = nmt_page_bond_constructed;
+	object_class->finalize    = nmt_page_bond_finalize;
+
 	editor_page_class->saved = nmt_page_bond_saved;
 }
diff --git a/libnm-core/nm-connection.c b/libnm-core/nm-connection.c
index ecfb978..5838c35 100644
--- a/libnm-core/nm-connection.c
+++ b/libnm-core/nm-connection.c
@@ -993,7 +993,7 @@ _normalize_team_port_config (NMConnection *self, GHashTable *parameters)
 static gboolean
 _normalize_required_settings (NMConnection *self, GHashTable *parameters)
 {
-	if (nm_connection_get_setting_vlan (self)) {
+	if (nm_connection_get_setting_vlan (self) || nm_connection_get_setting_bond (self)) {
 		if (!nm_connection_get_setting_wired (self)) {
 			nm_connection_add_setting (self, nm_setting_wired_new ());
 			return TRUE;
